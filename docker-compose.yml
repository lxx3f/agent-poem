
services:
  # MySQL数据库
  mysql:
    image: mysql:8.0
    container_name: ${PROJECT_NAME}-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD} 
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
    ports:
      - "${MYSQL_PORT}:${MYSQL_CONTAINER_PORT}"  # 端口映射也引用变量
    volumes:
      - ./database/mysql_data:/var/lib/mysql
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - shiyun-network 
  # phpMyAdmin服务
  phpmyadmin:
    image: phpmyadmin/phpmyadmin:latest  # 官方稳定镜像
    container_name: ${PROJECT_NAME}-phpmyadmin
    restart: always
    depends_on:
      - mysql  # 依赖mysql服务，确保mysql先启动
    environment:
      # 关键：指向mysql容器名（同网络内可直接访问）
      PMA_HOST: mysql
      # mysql容器内的端口（不是映射的外部端口）
      PMA_PORT: ${MYSQL_CONTAINER_PORT}
      # 根用户名
      PMA_USER: root
      # 引用.env中的mysql根密码
      PMA_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      # 开启持久化登录（可选）
      PMA_ARBITRARY: 1
      # 字符集匹配mysql配置
      MYSQL_CHARSET: utf8mb4
    ports:
      - "8081:80"  # 本地8080端口映射到容器内80端口（避免和其他服务冲突）
    networks:
      - shiyun-network  # 加入和mysql同个网络，确保互通
      
  # Redis缓存
  redis:
    image: redis:7.0
    container_name: ${PROJECT_NAME}-redis
    restart: always
    ports:
      - "${REDIS_PORT}:${REDIS_CONTAINER_PORT}"
    command: redis-server --requirepass ${REDIS_PASSWORD}  # 引用Redis密码
    volumes:
      - ./database/redis_data:/data
    networks:
      - shiyun-network

  # Milvus向量数据库（单机版）
  milvus-standalone:
    image: milvusdb/milvus:v2.3.0
    container_name: ${PROJECT_NAME}-milvus
    restart: always
    command: ["milvus", "run", "standalone"]
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000
    ports:
      - "${MILVUS_PORT}:19530"    # 固定容器内端口，映射端口引用变量
      - "${MILVUS_CONSOLE_PORT}:9091"
    volumes:
      - ./database/milvus_data:/var/lib/milvus
    depends_on:
      - etcd
      - minio
    networks:
      - shiyun-network

  # milvus依赖项
  etcd:
    image: quay.io/coreos/etcd:v3.5.5
    container_name: ${PROJECT_NAME}-etcd
    environment:
      ETCD_AUTO_COMPACTION_MODE: revision
      ETCD_AUTO_COMPACTION_RETENTION: "1000"
      ETCD_QUOTA_BACKEND_BYTES: "4294967296"
      ETCD_SNAPSHOT_COUNT: "50000"
    volumes:
      - ./database/etcd_data:/etcd
    command: etcd -advertise-client-urls=http://0.0.0.0:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd
    networks:
      - shiyun-network

  # ollama服务
  ollama:
    image: ollama/ollama:latest
    container_name: ${PROJECT_NAME}-ollama
    restart: always
    ports:
      - "11434:11434"
    volumes:
      - ./database/ollama_data:/ollama_data
    networks:
      - shiyun-network
    deploy:
      resources:
        limits:
          memory: "4g"
        reservations:
          memory: "512m"

  # Ollama模型初始化服务
  ollama-init:
    image: curlimages/curl:latest
    container_name: ${PROJECT_NAME}-ollama-init
    depends_on:
      - ollama
    command: |
      sh -c '
        echo "Waiting for Ollama to start...";
        until curl -sf http://ollama:11434/api/tags; do sleep 2; echo "Waiting for Ollama to start..."; done;
        echo "Ollama is running, pulling nomic-embed-text model...";
        curl -X POST http://ollama:11434/api/pull -H "Content-Type: application/json" -d "{\"name\":\"nomic-embed-text\"}";
        sleep 5;
        echo "Checking if model is ready...";
        until curl -sf http://ollama:11434/api/tags | grep -q "nomic-embed-text"; do
          echo "Model still downloading, waiting...";
          sleep 10;
        done;
        echo "Model nomic-embed-text is ready!"
      '
    networks:
      - shiyun-network

  # milvus依赖项
  minio:
    image: minio/minio:RELEASE.2023-03-20T20-16-18Z
    container_name: ${PROJECT_NAME}-minio
    environment:
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}  # 引用MinIO密钥
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
    ports:
      - "${MINIO_CONSOLE_PORT}:9001"
      - "${MINIO_PORT}:9000"
    volumes:
      - ./database/minio_data:/minio_data
    command: minio server /minio_data --console-address ":9001"
    networks:
      - shiyun-network

  # 后端服务
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ${PROJECT_NAME}-backend
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - DB_HOST=mysql
      - DB_PORT=${MYSQL_CONTAINER_PORT}
      - DB_USER=${MYSQL_USER}
      - DB_PASSWORD=${MYSQL_PASSWORD}
      - DB_NAME=${MYSQL_DATABASE}
      - MILVUS_HOST=milvus-standalone
      - MILVUS_PORT=${MILVUS_PORT}
      - REDIS_HOST=redis
      - REDIS_PORT=${REDIS_PORT}
      - MINIO_HOST=minio
      - OLLAMA_BASE_URL=http://ollama:11434
      # - OLLAMA_BASE_URL=http://host.docker.internal:11434

    ports:
      - "${BACKEND_PORT}:8000"
    volumes:
      - ./logs:/app/logs
    depends_on:
      - mysql
      - milvus-standalone
      - ollama-init
    networks:
      - shiyun-network

  # 前端服务
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: ${PROJECT_NAME}-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT}:80"
    depends_on:
      - backend
    networks:
      - shiyun-network

networks:
  shiyun-network:  # 网络名引用变量，动态生成
    driver: bridge

volumes:
  mysql_data:
  redis_data:
  milvus_data:
  etcd_data:
  minio_data: